// imports
importScripts('https://cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.min.js');

importScripts('js/sw-db.js');
importScripts('js/sw-utils.js');

const STATIC_CACHE = 'static-v2';
const DYNAMIC_CACHE = 'dynamic-v1';
const INMUTABLE_CACHE = 'inmutable-v1';

const APP_SHELL = [
	'/',
	'index.html',
	'css/style.css',
	'img/favicon.ico',
	'img/avatars/hulk.jpg',
	'img/avatars/ironman.jpg',
	'img/avatars/spiderman.jpg',
	'img/avatars/thor.jpg',
	'img/avatars/wolverine.jpg',
	'js/app.js',
	'js/sw-utils.js',
	'js/libs/plugins/mdtoast.min.js',
	'js/libs/plugins/mdtoast.min.css',
];

const APP_SHELL_INMUTABLE = [
	'https://fonts.googleapis.com/css?family=Quicksand:300,400',
	'https://fonts.googleapis.com/css?family=Lato:400,300',
	'https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.css',
	'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js',
	'https://cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.min.js',
];

self.addEventListener('install', (e) => {
	const cacheStatic = caches.open(STATIC_CACHE).then((cache) => cache.addAll(APP_SHELL));

	const cacheInmutable = caches
		.open(INMUTABLE_CACHE)
		.then((cache) => cache.addAll(APP_SHELL_INMUTABLE));

	e.waitUntil(Promise.all([cacheStatic, cacheInmutable]));
});

self.addEventListener('activate', (e) => {
	const respuesta = caches.keys().then((keys) => {
		keys.forEach((key) => {
			if (key !== STATIC_CACHE && key.includes('static')) {
				return caches.delete(key);
			}

			if (key !== DYNAMIC_CACHE && key.includes('dynamic')) {
				return caches.delete(key);
			}
		});
	});

	e.waitUntil(respuesta);
});

self.addEventListener('fetch', (e) => {
	let respuesta;

	if (e.request.url.includes('/api')) {
		// return respuesta????
		respuesta = manejoApiMensajes(DYNAMIC_CACHE, e.request);
	} else {
		respuesta = caches.match(e.request).then((res) => {
			if (res) {
				actualizaCacheStatico(STATIC_CACHE, e.request, APP_SHELL_INMUTABLE);
				return res;
			} else {
				return fetch(e.request).then((newRes) => {
					return actualizaCacheDinamico(DYNAMIC_CACHE, e.request, newRes);
				});
			}
		});
	}

	e.respondWith(respuesta);
});

// tareas asíncronas
self.addEventListener('sync', (e) => {
	console.log('SW: Sync');

	if (e.tag === 'nuevo-post') {
		// postear a BD cuando hay conexión
		const respuesta = postearMensajes();

		e.waitUntil(respuesta);
	}
});

/* Listen push notifications */
self.addEventListener('push', (e) => {
	const data = JSON.parse(e.data.text());

	const title = data.title;
	const options = {
		body: data.body,
		icon: `img/avatars/${data.user}.jpg`,
		badge: 'img/favicon.ico',
		image:
			'data:image/jpeg;base64,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',
		openUrl: '/',
		data: {
			url: '/',
			id: data.user,
		},
		actions: [
			{
				action: 'thor-action',
				title: 'Thor',
				icon: 'img/avatars/thor.jpg',
			},
			{
				action: 'ironman-action',
				title: 'Ironman',
				icon: 'img/avatars/ironman.jpg',
			},
		],
	};

	e.waitUntil(self.registration.showNotification(title, options));
});

self.addEventListener('notificationclick', (e) => {
	const { action, notification } = e;

	const response = clients.matchAll().then((clients) => {
		let client = clients.find((c) => {
			return c.visibilityState === 'visible';
		});

		if (client) {
			client.navigate(notification.data.url);
			client.focus();
		} else {
			clients.openWindow(notification.data.url);
		}
		return notification.close();
	});

	e.waitUntil(response);
});

self.addEventListener('notificationclose', (e) => {
	console.log('notification closed', e);
});
